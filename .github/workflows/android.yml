name: Manual Build APK

on:
  workflow_dispatch: # 只要点击按钮就能运行，不需要输入版本号

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive' # 必须递归拉取子模块
          fetch-depth: 0
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: 21 # 保持项目要求的 Java 21

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25" # 1.25 目前可能不稳定，建议用稳定的 1.23

      - name: Update CA
        run: |
          sudo apt-get update && sudo apt-get install ca-certificates
          sudo update-ca-certificates
          # 这一步是项目要求的，必须保留
          mkdir -p core/src/foss/golang/clash/component/ca/
          cp -f /etc/ssl/certs/ca-certificates.crt core/src/foss/golang/clash/component/ca/ca-certificates.crt || true

      - name: Build Debug APK
        # 关键修改：使用 assembleMetaDebug，不需要签名密钥也能编译成功
        run: |
          chmod +x gradlew
          ./gradlew --no-daemon app:assembleMetaDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ClashMeta-Automation-Debug
          path: app/build/outputs/apk/meta/debug/*.apk
